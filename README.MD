<p align="center">
  <img src="./resource/tinycoro_intro.jpg" alt="tinycoro Logo">
</p>

-----------------

# tinyCoro C++20 coroutine library with liburing

[![C++20](https://img.shields.io/badge/dialect-C%2B%2B20-blue)](https://en.cppreference.com/w/cpp/20)[![MIT license](https://img.shields.io/github/license/max0x7ba/atomic_queue)](https://github.com/sakurs2/tinyCoro/blob/master/LICENSE)![platform Linux x86_64](https://img.shields.io/badge/platform-Linux%20x86_64--bit-yellow)
![Version Badge](https://img.shields.io/badge/version-v1%2E1-red)
<!-- support below -->
<!-- [![Build Status](link/actions/workflows/cmake.yml/badge.svg)](link/actions/workflows/cmake.yml) -->
<!-- [![CI](https://github.com/jbaldwin/libcoro/actions/workflows/ci-coverage.yml/badge.svg)](https://github.com/jbaldwin/libcoro/actions/workflows/ci-coverage.yml)
[![Coverage Status](https://coveralls.io/repos/github/jbaldwin/libcoro/badge.svg?branch=main)](https://coveralls.io/github/jbaldwin/libcoro?branch=main)
[![Codacy Badge](https://app.codacy.com/project/badge/Grade/c190d4920e6749d4b4d1a9d7d6687f4f)](https://www.codacy.com/gh/jbaldwin/libcoro/dashboard?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=jbaldwin/libcoro&amp;utm_campaign=Badge_Grade) -->

> **âš ï¸æŸ¥çœ‹æ—§ç‰ˆæœ¬è¯·åˆ‡æ¢åˆ†æ”¯**
> **â­é¡¹ç›®åˆ¶ä½œä¸æ˜“ï¼Œè¯·ç‚¹å‡»staræ”¯æŒä¸€ä¸‹â¤ï¸**

> **ğŸ”¥tinyCoroçš„æ›´æ–°ä¼šæŒç»­è¿›è¡Œï¼Œå¹¶è‡´åŠ›äºæ‰“é€ å¯¹æ ‡å·¥ä¸šæ ‡å‡†çš„ä»£ç è´¨é‡å’Œæ€§èƒ½ï¼Œæ¬¢è¿æ‚¨ä¸æˆ‘å…±åŒå»ºè®¾tinyCoroğŸ’ª**

tinyCoroæ˜¯ä¸€ä¸ªlinuxç³»ç»Ÿç¯å¢ƒä¸‹çš„ä»¥**C++20åç¨‹æŠ€æœ¯å’Œlinux io_uringæŠ€æœ¯ç›¸ç»“åˆ**çš„é«˜æ€§èƒ½å¼‚æ­¥åç¨‹åº“ï¼Œå…¶éƒ¨åˆ†ä»£ç å‚è€ƒ[libcoro](https://github.com/jbaldwin/libcoro)ï¼Œæ„å›¾ä¸ºå¼€å‘è€…æä¾›è¾ƒå¼‚æ­¥ioæ›´ä¾¿æ·ï¼Œæ€§èƒ½æ›´ä¼˜çš„åº“æ”¯æŒã€‚é«˜æ•ˆä¸”å…¨èƒ½çš„io_uringå’ŒC++20æ— æ ˆåç¨‹çš„è½»é‡çº§åˆ‡æ¢ç›¸ç»„åˆä½¿å¾—tinyCoroå¯ä»¥è½»æ¾åº”å¯¹I/Oå¯†é›†å‹è´Ÿè½½ï¼Œè€ŒC++20åç¨‹çš„ç‰¹æ€§ä½¿å¾—ç”¨æˆ·å¯ä»¥ä»¥åŒæ­¥çš„æ–¹å¼ç¼–å†™å¼‚æ­¥æ‰§è¡Œçš„ä»£ç ï¼Œå¤§å¤§é™ä½äº†åæœŸç»´æŠ¤çš„å·¥ä½œé‡ï¼Œä¸”ä»£ç é€»è¾‘éå¸¸ç®€å•ä¸”æ¸…æ™°ï¼Œé™¤æ­¤å¤–**tinyCoroè¿˜æä¾›äº†åç¨‹å®‰å…¨ç»„ä»¶ï¼Œä»¥åç¨‹suspendä»£æ›¿çº¿ç¨‹é˜»å¡ä¾¿äºç”¨æˆ·æ„å»ºåç¨‹å®‰å…¨ä¸”é«˜æ•ˆçš„ä»£ç ã€‚** ä¸‹å›¾å±•ç¤ºäº†tinyCoroçš„ä»»åŠ¡è°ƒåº¦æœºåˆ¶ï¼š

![tinycoroè°ƒåº¦æœºåˆ¶](./resource/tinycoro_core.png)

tinyCoroçš„è®¾è®¡å¹¶ä¸å¤æ‚ï¼Œæ¯ä¸ªæ‰§è¡Œå¼•æ“æ‹¥æœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å’Œio_uringå®ä¾‹æ¥å¤„ç†å¤–éƒ¨ä»»åŠ¡ï¼Œè€Œè°ƒåº¦å™¨é€šè¿‡åˆ›å»ºå¤šä¸ªæ‰§è¡Œå¼•æ“æ¥æé«˜ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›ï¼Œè®¾è®¡æ¡†æ¶å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![tinyCoroæ¡†æ¶å›¾](./resource/tinycoro_arch.png)

ç»è¿‡æµ‹è¯•ç”±tinyCoroå®ç°çš„echo serveråœ¨1kbyteè´Ÿè½½å’Œ100ä¸ªå¹¶å‘è¿æ¥ä¸‹å¯è¾¾åˆ°100wQPSã€‚

## tinyCoroLab

ä¸ºäº†ä½¿æ›´å¤šçš„åŒå­¦äº†è§£C++åç¨‹å’Œliburingï¼ŒtinyCoroä½œè€…å‚ç…§cmu15445 bustubç ”å‘äº†[tinyCoroLab](https://github.com/sakurs2/tinyCoroLab)è¯¾ç¨‹ï¼Œ5å¤§å®éªŒæ­é…ç²¾å¿ƒç¼–å†™çš„åŠŸèƒ½ã€å†…å­˜å®‰å…¨ä»¥åŠæ€§èƒ½æµ‹è¯•ï¼Œå¹¶é…å¤‡å†…å®¹ä¸°å¯Œçš„å®éªŒæ–‡æ¡£ï¼ŒåŠ©åŠ›å®éªŒè€…å¯¹C++ç¼–ç¨‹ã€å¼‚æ­¥ç¼–ç¨‹å’Œå¤šçº¿ç¨‹ç¼–ç¨‹æŠ€æœ¯æ›´ä¸Šä¸€å±‚æ¥¼ï¼

tinyCoroLabå®éªŒè¯¾ç¨‹å…è´¹ï¼ï¼ï¼å¿«ç‚¹å‡»[tinyCoroLab](https://github.com/sakurs2/tinyCoroLab)ä»¥åŠåœ¨çº¿æ–‡æ¡£[tinycorolab-docs](https://sakurs2.gitbook.io/tinycorolab-docs/)å¼€å¯å±äºä½ çš„tinyCoroä¹‹æ—…å§ï¼

## Overview

- [tinyCoro C++20 coroutine library with liburing](#tinycoro-c20-coroutine-library-with-liburing)
  - [tinyCoroLab](#tinycorolab)
  - [Overview](#overview)
  - [Usage](#usage)
    - [ğŸ¤–feature](#feature)
      - [ğŸ”¥å¼ºå¤§çš„schduler::loop](#å¼ºå¤§çš„schdulerloop)
      - [ğŸš€å¯æ— é™æ·»åŠ ä»»åŠ¡ä¸”æ°¸ä¸é˜»å¡çš„æ‰§è¡Œå¼•æ“](#å¯æ— é™æ·»åŠ ä»»åŠ¡ä¸”æ°¸ä¸é˜»å¡çš„æ‰§è¡Œå¼•æ“)
    - [timer](#timer)
    - [event](#event)
    - [latch](#latch)
    - [wait\_group](#wait_group)
    - [mutex](#mutex)
    - [when\_all](#when_all)
    - [condition\_variable](#condition_variable)
    - [channel](#channel)
    - [tcp\_stdin\_echo\_client](#tcp_stdin_echo_client)
    - [tcp\_echo\_server](#tcp_echo_server)
  - [benchmark](#benchmark)
    - [å®éªŒç¯å¢ƒ](#å®éªŒç¯å¢ƒ)
      - [wsl2](#wsl2)
      - [ubuntu](#ubuntu)
    - [æµ‹è¯•ç»“æœ](#æµ‹è¯•ç»“æœ)
      - [128b-avg(req/s)](#128b-avgreqs)
      - [1k-avg(req/s)](#1k-avgreqs)
      - [16k-avg(req/s)](#16k-avgreqs)
  - [build](#build)
    - [æ„å»ºç¯å¢ƒ](#æ„å»ºç¯å¢ƒ)
    - [æ„å»ºæµç¨‹](#æ„å»ºæµç¨‹)
    - [cmake options](#cmake-options)
  - [æ›´æ–°æ—¥å¿—](#æ›´æ–°æ—¥å¿—)
  - [support](#support)

## Usage

### ğŸ¤–feature

#### ğŸ”¥å¼ºå¤§çš„schduler::loop

tinyCoroå…¶æœ¬èº«ä¸ä»…å…·æœ‰é«˜æ•ˆçš„ä»»åŠ¡æ‰§è¡Œæœºåˆ¶ï¼Œè¿˜é¢å¤–å®ç°äº†é«˜æ•ˆçš„åç¨‹åŒæ­¥ç»„ä»¶ï¼Œå½“çº¿ç¨‹å› çº¿ç¨‹åŒæ­¥ç»„ä»¶é™·å…¥é˜»å¡æ€æ—¶ä¼šè®©å‡ºæ‰§è¡Œæƒï¼Œè€Œé€šè¿‡ä½¿ç”¨åç¨‹åŒæ­¥ç»„ä»¶ï¼Œçº¿ç¨‹å½“å‰æ‰§è¡Œçš„åç¨‹å¦‚é™·å…¥é˜»å¡ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šè½¬è€Œæ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œè¿›è€Œå®ç°å¯¹cpuçš„å……åˆ†åˆ©ç”¨ã€‚

å¯¹äºç”¨æˆ·ï¼Œä»…éœ€è¦æŒ‰ç…§ä¸‹åˆ—æ–¹å¼ä½¿ç”¨tinyCoroå³å¯ï¼š

```cpp
task<> func(paras...) {
  // codes...
  submit_to_scheduler(...);
  // or submit_to_context(...);
  // codes...
}

int main() {
  scheduler::init();
  submit_to_scheduler(func(paras...));
  schduler::loop(); // just loop work
  // when loop finish, all work have been done!
  return 0;
}
```

tinyCoroçš„schedulerå¯ä»¥æ„ŸçŸ¥åˆ°å„ä¸ªcontextçš„è¿è¡ŒçŠ¶æ€ï¼Œ**`schduler::loop`åœ¨æ‰€æœ‰contextå…¨éƒ¨å®Œæˆä»»åŠ¡åæ‰ä¼šå‘å„ä¸ªcontextä¸‹è¾¾åœæ­¢æŒ‡ä»¤ï¼Œ** å› æ­¤è¯¥å‡½æ•°ä¸€å®šä¼šåœ¨æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åè¿”å›ï¼ŒåŸºäºæ­¤ç”¨æˆ·å¯ä»¥åœ¨åç¨‹å†…éƒ¨è‡ªç”±çš„å‘scheduleræ´¾å‘æ–°ä»»åŠ¡ï¼Œschedulerä¸€å®šä¿è¯å®Œæˆå…¨éƒ¨ä»»åŠ¡ï¼

#### ğŸš€å¯æ— é™æ·»åŠ ä»»åŠ¡ä¸”æ°¸ä¸é˜»å¡çš„æ‰§è¡Œå¼•æ“

tinyCoroæ‰§è¡Œå¼•æ“æ‰€æŒæœ‰çš„ä»»åŠ¡é˜Ÿåˆ—çš„å®¹é‡é€šè¿‡é…ç½®æ–‡ä»¶å‚æ•°æ¥å®šä¹‰ï¼Œå®¹é‡ä»…é™åˆ¶schedulerå¯åŠ¨å‰æ‰€é¢„å…ˆæ¥æ”¶çš„ä»»åŠ¡æ•°é‡ï¼Œæäº¤ä»»åŠ¡è¶…å‡ºå®¹é‡æ—¥å¿—ä¼šæ‰“å°é”™è¯¯ä¿¡æ¯ä¸”å¿½ç•¥è¯¥ä»»åŠ¡ã€‚

**ä½†åœ¨åç¨‹ä»»åŠ¡å†…éƒ¨å¯æ— é™é€šè¿‡`submit_to_scheduler`æˆ–è€…`submit_to_context`æ´¾å‘æ–°ä»»åŠ¡ï¼Œä¸”ä»»æ„å·¥ä½œçº¿ç¨‹å‡ä¸ä¼šå› ä»»åŠ¡è¶…å‡ºå®¹é‡è€Œé˜»å¡ï¼Œä½†è¶…å‡ºå®¹é‡ä¼šå½±å“åˆ°ä»»åŠ¡çš„è°ƒåº¦é¡ºåºã€‚**

### timer

timeræ˜¯ä¸€ä¸ªå¯è¢«åç¨‹è°ƒç”¨çš„å®šæ—¶å™¨ï¼Œé€šè¿‡`co_await timer`åç¨‹å°†ä¼šé™·å…¥suspendçŠ¶æ€ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹è¿è¡Œã€‚

```C++
#include "coro/coro.hpp"

using namespace coro;

using coro::time::timer;

task<> timer_func()
{
    log::info("timer begin");
    auto result = co_await timer{}.add_seconds(3).add_mseconds(500);
    log::info("timer end,  result: {}", result);
}

int main(int argc, char const* argv[])
{
    /* code */
    scheduler::init();
    submit_to_scheduler(timer_func());
    scheduler::loop();
    return 0;
}
```

### event

eventç”¨äºåŒæ­¥åç¨‹ï¼Œåªæœ‰eventå¤„äºsetçŠ¶æ€æ—¶å¯¹eventè°ƒç”¨`wait`çš„åç¨‹æ‰å¯ä»¥æ¢å¤æ‰§è¡Œï¼Œå¦åˆ™é™·å…¥suspendçŠ¶æ€ã€‚eventçš„æ¨¡æ¿å‚æ•°éç©ºæƒ…å†µä¸‹è¿˜å¯ä»¥ç”¨äºé€šè¿‡`set`è®¾ç½®å€¼å¹¶ç”±`wait`å°†è¯¥å€¼è¿”å›ã€‚

```C++
#include "coro/coro.hpp"

using namespace coro;

#define TASK_NUM 5

event<> ev;

task<> set_task()
{
    log::info("set task ready to sleep");
    utils::sleep(3);
    log::info("ready to set event");
    ev.set();
    co_return;
}

task<> wait_task(int i)
{
    co_await ev.wait();
    log::info("task {} wake up by event", i);
    co_return;
}

int main(int argc, char const* argv[])
{
    /* code */
    scheduler::init();

    for (int i = 0; i < TASK_NUM - 1; i++)
    {
        submit_to_scheduler(wait_task(i));
    }
    submit_to_scheduler(set_task());

    scheduler::loop();
    return 0;
}
```

### latch

latchä¸C++ std::latchåŠŸèƒ½ç›¸åŒï¼Œç”¨äºåŒæ­¥åç¨‹ï¼Œåªæœ‰å½“å…¶å†…éƒ¨è®¡æ•°é€šè¿‡`count_down`é™è‡³0æ—¶å¯¹å…¶è°ƒç”¨`wait`çš„åç¨‹æ‰å¯ä»¥æ¢å¤è¿è¡Œï¼Œå¦åˆ™é™·å…¥suspendçŠ¶æ€ã€‚

```C++
#include "coro/coro.hpp"

using namespace coro;

#define TASK_NUM 5

latch l(TASK_NUM - 1);

task<> set_task(int i)
{
    log::info("set task ready to sleep");
    utils::sleep(2);
    l.count_down();
    co_return;
}

task<> wait_task(int i)
{
    co_await l.wait();
    log::info("task {} wake up by latch", i);
    co_return;
}

int main(int argc, char const* argv[])
{
    /* code */
    scheduler::init();

    submit_to_scheduler(wait_task(TASK_NUM - 1));
    for (int i = 0; i < TASK_NUM - 1; i++)
    {
        submit_to_scheduler(set_task(i));
    }

    scheduler::loop();
    return 0;
}
```

### wait_group

wait_groupçš„è®¾è®¡å‚è€ƒgolangä¸­çš„wait_groupï¼Œä¸latchç›¸æ¯”åœ¨å…¶å†…éƒ¨è®¡æ•°å¯ä»¥è¢«å¢åŠ ï¼Œå› æ­¤å³ä½¿è®¡æ•°é€šè¿‡`done`é™è‡³0è€Œåˆé€šè¿‡`add`å¢è‡³1ï¼Œé‚£ä¹ˆæ­¤æ—¶å¯¹å…¶è°ƒç”¨`wait`çš„åç¨‹å‡ä¼šé™·å…¥suspendçŠ¶æ€ã€‚

```C++
#include "coro/coro.hpp"

using namespace coro;

wait_group wg{0};

task<> wait()
{
    co_await wg.wait();
    log::info("wait finish");
}

task<> done()
{
    utils::sleep(2);
    wg.done();
    log::info("done...");
    co_return;
}

int main(int argc, char const* argv[])
{
    /* code */
    scheduler::init();
    wg.add(3);

    submit_to_scheduler(wait());
    submit_to_scheduler(done());
    submit_to_scheduler(done());
    submit_to_scheduler(done());

    scheduler::loop();

    return 0;
}
```

### mutex

mutexä¸C++ä¸­çš„mutexåŠŸèƒ½ä¸€è‡´ï¼Œå¦‚æœåç¨‹è¯•å›¾è·å–ä¸€æŠŠå¤„äºåŠ é”çŠ¶æ€çš„é”ï¼Œé‚£ä¹ˆå°†é™·å…¥suspendçŠ¶æ€ï¼Œé€šè¿‡mutexä¿è¯åç¨‹å¹¶å‘å®‰å…¨æ€§ã€‚

```C++
#include "coro/coro.hpp"

using namespace coro;

#define TASK_NUM 100

mutex mtx;
int   data = 0;

task<> add_task(int i)
{
    co_await mtx.lock();
    log::info("task {} fetch lock", i);
    for (int i = 0; i < 10000; i++)
    {
        data += 1;
    }
    mtx.unlock();
    co_return;
}

int main(int argc, char const* argv[])
{
    /* code */
    scheduler::init();

    for (int i = 0; i < TASK_NUM; i++)
    {
        submit_to_scheduler(add_task(i));
    }

    scheduler::loop();
    assert(data == 1000000);
    return 0;
}
```

### when_all

when_allç”¨äºç­‰å¾…å…¶åˆ—è¡¨ä¸­çš„åç¨‹å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œåœ¨ç­‰å¾…æ—¶ä¼šé™·å…¥suspendçŠ¶æ€ã€‚

```C++
#include "coro/coro.hpp"

using namespace coro;

task<> sub_func(int i)
{
    log::info("sub func {} running...", i);
    co_return;
}

task<> func(int i)
{
    log::info("ready to wait all sub task");
    co_await when_all(sub_func(i + 1), sub_func(i + 2), sub_func(i + 3));
    log::info("wait all sub task finish");
    co_return;
}

int main(int argc, char const* argv[])
{
    /* code */
    scheduler::init();

    submit_to_scheduler(func(0));

    scheduler::loop();
    return 0;
}
```

### condition_variable

condition_variableä¸C++ std::condition_variableåŠŸèƒ½ä¸€è‡´ï¼Œå¹¶ä¸”tinyCoroçš„condition_variableæ­é…çš„æ˜¯tinyCoroä¸­çš„mutexï¼Œåˆ©ç”¨condition_variableå¯ä»¥æ„å»ºåç¨‹å®‰å…¨çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ä»¥åŠåŒæ­¥åç¨‹æ‰§è¡Œçš„æœ‰åºæ€§ç­‰åŠŸèƒ½ã€‚

```C++
#include <queue>

#include "coro/coro.hpp"

using namespace coro;

cond_var        cv;
mutex           mtx;
std::queue<int> que;

task<> consumer()
{
    int  cnt{0};
    auto lock = co_await mtx.lock_guard();
    log::info("consumer hold lock");
    while (cnt < 100)
    {
        co_await cv.wait(mtx, [&]() { return !que.empty(); });
        while (!que.empty())
        {
            log::info("consumer fetch value: {}", que.front());
            que.pop();
            cnt++;
        }
        log::info("consumer cnt: {}", cnt);
        cv.notify_one();
    }
    log::info("consumer finish");
}

task<> producer()
{
    for (int i = 0; i < 10; i++)
    {
        auto lock = co_await mtx.lock_guard();
        log::info("producer hold lock");
        co_await cv.wait(mtx, [&]() { return que.size() < 10; });
        for (int j = 0; j < 10; j++)
        {
            que.push(i * 10 + j);
        }
        log::info("producer add value finish");
        cv.notify_one();
    }
}

int main(int argc, char const* argv[])
{
    /* code */
    scheduler::init();

    submit_to_scheduler(consumer());
    submit_to_scheduler(producer());

    scheduler::loop();
    return 0;
}
```

### channel

channelçš„è®¾è®¡å‚è€ƒgolang channelï¼Œå…¶æœ¬èº«ä¸ºå®¹é‡å›ºå®šçš„é˜»å¡å¼åç¨‹å®‰å…¨çš„å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å‹ï¼Œæ‰€æœ‰åç¨‹å› å¯¹channelæ“ä½œè€Œé˜»å¡æ—¶ä¼šé™·å…¥suspendçŠ¶æ€ã€‚

```C++
#include "coro/coro.hpp"

using namespace coro;

channel<int> ch;

task<> producer(int i)
{
    for (int i = 0; i < 10; i++)
    {
        co_await ch.send(i);
    }

    ch.close();
    co_return;
}

task<> consumer(int i)
{
    while (true)
    {
        auto data = co_await ch.recv();
        if (data)
        {
            log::info("consumer {} receive data: {}", i, *data);
        }
        else
        {
            break;
        }
    }
}

int main(int argc, char const* argv[])
{
    /* code */
    scheduler::init();

    submit_to_scheduler(producer(0));
    submit_to_scheduler(consumer(1));

    scheduler::loop();
    return 0;
}
```

### tcp_stdin_echo_client

ç”±tinyCoroå®ç°çš„tcpå®¢æˆ·ç«¯ï¼Œä¸ä»…å¯ä»¥æ‰“å°tcpæœåŠ¡ç«¯å‘æ¥çš„æ¶ˆæ¯ï¼Œç”¨æˆ·è¿˜èƒ½åœ¨ç»ˆç«¯è¾“å…¥æ–‡å­—æ¥å‘tcpæœåŠ¡ç«¯å‘é€æ¶ˆæ¯ã€‚

```C++
#include "coro/coro.hpp"

using namespace coro;

#define BUFFLEN 10240

task<> echo(int sockfd)
{
    char buf[BUFFLEN] = {0};
    int  ret          = 0;
    auto conn         = net::tcp_connector(sockfd);

    while (true)
    {
        ret = co_await net::stdin_awaiter(buf, BUFFLEN, 0);
        log::info("receive data from stdin: {}", buf);
        ret = co_await conn.write(buf, ret);
    }
}

task<> client(const char* addr, int port)
{
    auto client = net::tcp_client(addr, port);
    int  ret    = 0;
    int  sockfd = 0;
    sockfd      = co_await client.connect();
    assert(sockfd > 0 && "connect error");

    if (sockfd <= 0)
    {
        log::error("connect error");
        co_return;
    }

    submit_to_scheduler(echo(sockfd));

    char buf[BUFFLEN] = {0};
    auto conn         = net::tcp_connector(sockfd);
    while ((ret = co_await conn.read(buf, BUFFLEN)) > 0)
    {
        log::info("receive data from net: {}", buf);
    }

    ret = co_await conn.close();
    assert(ret == 0);
}

int main(int argc, char const* argv[])
{
    /* code */
    scheduler::init();
    submit_to_scheduler(client("localhost", 8000));

    scheduler::loop();
    return 0;
}
```

### tcp_echo_server

ç”±tinyCoroå®ç°çš„tcpæœåŠ¡ç«¯ã€‚

```C++
#include "coro/coro.hpp"

using namespace coro;

#define BUFFLEN 10240

task<> session(int fd)
{
    char buf[BUFFLEN] = {0};
    auto conn         = net::tcp_connector(fd);
    int  ret          = 0;
    while ((ret = co_await conn.read(buf, BUFFLEN)) > 0)
    {
        log::info("client {} receive data: {}", fd, buf);
        ret = co_await conn.write(buf, ret);
    }

    ret = co_await conn.close();
    log::info("client {} close connect", fd);
    assert(ret == 0);
}

task<> server(int port)
{
    log::info("server start in {}", port);
    auto server = net::tcp_server(port);
    int  client_fd;
    while ((client_fd = co_await server.accept()) > 0)
    {
        log::info("server receive new connect");
        submit_to_scheduler(session(client_fd));
    }
}

int main(int argc, char const* argv[])
{
    /* code */
    scheduler::init();

    submit_to_scheduler(server(8000));
    scheduler::loop();
    return 0;
}
```

## benchmark

åœ¨liburing 2.10ç‰ˆæœ¬ä¸‹å¯¹ç”±tinyCoroå®ç°çš„tcp_echo_serverè¿›è¡Œå‹æµ‹ï¼Œå‹æµ‹å·¥å…·ä½¿ç”¨[rust_echo_bench](https://github.com/haraldh/rust_echo_bench)ï¼ŒåŸºçº¿æ¨¡å‹é€‰ç”¨[rust_echo_server](https://github.com/haraldh/rust_echo_server)ã€‚

### å®éªŒç¯å¢ƒ

benchmarkåˆ†åˆ«ä¼šåœ¨wsl2å’Œubuntuç‰©ç†æœºä¸­æµ‹ç®—ã€‚

#### wsl2

- **æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼š** Ubuntu 22.04.5 LTS
- **å†…æ ¸ç‰ˆæœ¬ï¼š** 5.15.167.4-microsoft-standard-WSL2
- **ç³»ç»Ÿè¯¦ç»†ä¿¡æ¯ï¼š** Linux DESKTOP-59OORP1 5.15.167.4-microsoft-standard-WSL2 #1 SMP Tue Nov 5 00:21:55 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux
- **å†…å­˜å¤§å°ï¼š** 7.4Gi

#### ubuntu

- **æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼š** Ubuntu 24.04.2 LTS
- **å†…æ ¸ç‰ˆæœ¬ï¼š** 6.8.0-55-generic
- **ç³»ç»Ÿè¯¦ç»†ä¿¡æ¯ï¼š** Linux ubuntu 6.8.0-55-generic #57-Ubuntu SMP PREEMPT_DYNAMIC Wed Feb 12 23:42:21 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux
- **å†…å­˜å¤§å°ï¼š** 31Gi

### æµ‹è¯•ç»“æœ

é’ˆå¯¹ä¸åŒè´Ÿè½½å¤§å°å’Œä¸åŒå¹¶å‘è¿æ¥æ•°è¿›è¡Œå‹æµ‹ã€‚

#### 128b-avg(req/s)

|  | tinycoro(wsl2) | tinycoro(ubuntu) | rust_echo_server(wsl2) | rust_echo_server(ubuntu) |  
|:-------:|:-------:|:-------:|:-------:|:-------:|
| 1   | 15906  | 81228  | 18286  | 88452 |
| 10  | 129679 | 595051 | 144092 | 701498|
| 50  | 1037350| 621318 | 1051087| 683328|
| 100 | 1102234|661939  | 1011170|662700 |

#### 1k-avg(req/s)

|  | tinycoro(wsl2) | tinycoro(ubuntu) | rust_echo_server(wsl2) | rust_echo_server(ubuntu) |  
|:-------:|:-------:|:-------:|:-------:|:-------:|
| 1   | 17082  | 77259  | 17885  | 83227 |
| 10  | 124883 | 586725 | 139094 | 683537|
| 50  | 986684 | 616243 | 1000662|669019 |
| 100 | 1034611| 637657 |988743  | 647984|

#### 16k-avg(req/s)

|  | tinycoro(wsl2) | tinycoro(ubuntu) | rust_echo_server(wsl2) | rust_echo_server(ubuntu) |  
|:-------:|:-------:|:-------:|:-------:|:-------:|
| 1   | 15991  | 47988  | read error | read error |
| 10  | 111741 | 518705 | read error | read error |
| 50  | 820905 | 464276 | read error | read error |
| 100 | 817026 | 437072 | read error | read error |

<div style="display: flex; justify-content: space-between; width: 100%;">
  <img src="./resource/benchmark_ubuntu.png" alt="benchmark_ubuntu" style="width: 48%; height: auto;">
  <img src="./resource/benchmark_wsl2.png" alt="benchmark_wsl2" style="width: 48%; height: auto;">
</div>

è¯¦ç»†çš„benchmarkè¿‡ç¨‹è¯·å‚è€ƒ[benchmark/README.MD](https://github.com/sakurs2/tinyCoroLab/blob/master/benchmark/README.MD)ã€‚

## build

### æ„å»ºç¯å¢ƒ

- æ“ä½œç³»ç»Ÿï¼šlinuxç³»ç»Ÿï¼Œæœ€å¥½æ˜¯ubuntuæ–°ç‰ˆæœ¬ï¼Œwsl2ä¸è™šæ‹Ÿæœºå‡å¯
- ç¼–è¯‘å™¨ï¼šæ”¯æŒC++20ç‰ˆæœ¬çš„gccç¼–è¯‘å™¨
- cmakeï¼š3.15ç‰ˆæœ¬ä»¥ä¸Š

### æ„å»ºæµç¨‹

é¦–å…ˆå…‹éš†é¡¹ç›®åˆ°æœ¬åœ°ï¼š

```shell
git clone https://github.com/sakurs2/tinyCoro
```

åˆå§‹åŒ–æ‰€æœ‰å­é¡¹ç›®ï¼š

```shell
cd tinyCoro
git submodule update --init --recursive
```

æ„å»ºliburing

```shell
cd third_party/liburing
./configure --cc=gcc --cxx=g++;
make -j$(nproc);
make liburing.pc
sudo make install;
```

å›åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œé¡¹ç›®æ„å»ºï¼š

```shell
mkdir build
cd build
cmake ..
make -j$(nproc)
```

### cmake options

| åç§° | é»˜è®¤å€¼ | ä½œç”¨ |
|:-------:|:-------:|:-------:|
| ENABLE_UNIT_TESTS   | ON  | å…è®¸æ„å»ºæµ‹è¯•  |
| ENABLE_DEBUG_MODE  | OFF | ONä»£è¡¨å¼€å¯debugæ¨¡å¼ï¼Œå¦åˆ™ä¸ºreleaseæ¨¡å¼ |
| ENABLE_BUILD_SHARED_LIBS  | OFF | åº“çš„é»˜è®¤æ„å»ºä¸ºåŠ¨æ€åº“ |

## æ›´æ–°æ—¥å¿—

è¯·ç‚¹å‡»ğŸ‘‰[tinyCoro update log](https://sakurs2.gitbook.io/tinycorolab-docs/updatelog)

## support

å¯¹äºtinyCoroçš„ä»»ä½•ç–‘é—®è¯·è®¿é—®[tinyCoro issurs](https://github.com/sakurs2/tinyCoro/issues)ã€‚

æ–°ç‰¹æ€§æ·»åŠ ä»¥åŠbugä¿®å¤è¯·è®¿é—®[tinyCoro pulls](https://github.com/sakurs2/tinyCoro/pulls)ã€‚
